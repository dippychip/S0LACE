<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <title>S0LACE • Media Player</title>

    <link rel="shortcut icon" content="favicon.ico" />
    <link rel="stylesheet" href="index.css" />

    <!-- global settings / tab cloak -->
    <script src="global-hub.js" defer></script>

    <!-- Scramjet plumbing (NO index.js here) -->
    <script src="baremux/index.js" defer></script>
    <script src="epoxy/index.js" defer></script>
    <script src="register-sw.js" defer></script>
  </head>

  <body>
    <header class="site-header">
      <div class="site-title">
        S0LACE
      </div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="media.html" class="active">Media</a>
        <a href="apps.html">Apps</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main class="player-main">
      <div class="player-info">
        <div class="player-left" id="player-title">Loading…</div>
        <div class="player-actions">
          <a id="open-direct" href="#" target="_blank" rel="noreferrer">OPEN RAW</a>
          <button type="button" id="reload-btn">RELOAD</button>
        </div>
      </div>

      <div class="player-frame-wrap">
        <iframe id="media-frame" src="about:blank"></iframe>
      </div>

      <div class="no-src" id="no-src" style="display:none;">
        no media source provided.<br />
        go back and pick something from the media page.
      </div>
    </main>

    <script>
      // --- helpers ---
      function getParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      async function initProxyTransport() {
        // register service worker (same helper used on main proxy page)
        try {
          if (typeof registerSW === "function") {
            await registerSW();
          }
        } catch (err) {
          console.error("SW registration failed in mediaplayer:", err);
        }

        // set up BareMux -> Epoxy transport, same idea as index.js but without Scramjet frame
        if (typeof BareMux === "undefined") {
          console.warn("BareMux is not available yet");
          return;
        }

        const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
        const wispUrl =
          (location.protocol === "https:" ? "wss" : "ws") +
          "://" +
          location.host +
          "/wisp/";

        try {
          const current = await connection.getTransport();
          if (current !== "/epoxy/index.mjs") {
            await connection.setTransport("/epoxy/index.mjs", [{ wisp: wispUrl }]);
          }
        } catch (err) {
          console.error("Failed to set BareMux transport in mediaplayer:", err);
        }
      }

      async function boot() {
        const frame = document.getElementById("media-frame");
        const noSrc = document.getElementById("no-src");
        const titleEl = document.getElementById("player-title");
        const openDirect = document.getElementById("open-direct");
        const reloadBtn = document.getElementById("reload-btn");

        const src = getParam("src");
        const title = getParam("title") || "Media";

        if (titleEl) titleEl.textContent = title;

        if (!src) {
          if (frame) frame.style.display = "none";
          if (noSrc) noSrc.style.display = "flex";
          if (openDirect) openDirect.style.display = "none";
          if (reloadBtn) reloadBtn.style.display = "none";
          return;
        }

        // set "OPEN RAW" link to the unproxied src for debugging / fallback
        if (openDirect) {
          openDirect.href = src;
        }

        // init BareMux + SW FIRST so we don't hit "no bare clients"
        await initProxyTransport();

        // now load the proxied URL into iframe
        if (frame) {
          frame.src = src;
        }

        if (reloadBtn) {
          reloadBtn.addEventListener("click", () => {
            if (frame) frame.src = frame.src;
          });
        }
      }

      window.addEventListener("DOMContentLoaded", boot);
    </script>
  </body>
</html>
