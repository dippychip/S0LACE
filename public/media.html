<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <title>S0LACE • Media</title>

    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="stylesheet" href="index.css" />
    <script src="global-hub.js" defer></script>
  </head>

  <body>
    <header class="site-header">
      <div class="site-title">S0LACE</div>
      <nav class="site-nav">
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="media.html" class="active">Media</a>
        <a href="apps.html">Apps</a>
        <a href="settings.html">Settings</a>
      </nav>
    </header>

    <main>
      <div class="page-header">
        <h1>Media</h1>
        <div class="sub">
          <span>Auto-updating</span> list of movies & shows powered by TMDB.
        </div>
      </div>

      <!-- FILTER -->
      <div class="games-search-wrap">
        <span class="search-label">FILTER &gt;</span>
        <input id="media-search" type="text"
               placeholder="filter movies & shows..."
               autocomplete="off" />
      </div>

      <!-- SORT DROPDOWN -->
      <div style="margin:6px 0 14px; font-size:9px;">
        <label for="sort-select">SORT &gt;</label>
        <select id="sort-select" style="font-size:9px;">
          <option value="az">A → Z</option>
          <option value="za">Z → A</option>
          <option value="popularity">Popularity</option>
          <option value="released">Release Date</option>
        </select>
      </div>

      <!-- TMDB STATUS -->
      <div id="tmdb-status"
           style="font-size:9px; color:#7f7f7f; margin:4px 0 10px;">
        Loading popular titles…
      </div>

      <div class="media-grid" id="media-grid">
        <!-- Example static card -->
        <a class="media-card"
           href="#"
           data-title="Interstellar"
           data-tmdb-id="157336">
          <div class="poster-thumb">
            <img src="thumbs/interstellar-poster.jpg" alt="Interstellar" />
            <div class="media-overlay">Interstellar</div>
          </div>
        </a>
      </div>

      <div id="media-empty">No media matches that search.</div>
    </main>

    <script>
      /* ============================================================
         CONFIG
      ============================================================ */
      const TMDB_KEY = "2d1351cf74f73892042699d0431b799a"; // your v3 key
      const TMDB_IMG_BASE = "https://image.tmdb.org/t/p/w342";

      // OPTION B → Proxy posters through Scramjet ALWAYS
      function proxiedImg(path) {
        return "/scramjet/" + TMDB_IMG_BASE + path;
      }

      const mediaGrid = document.getElementById("media-grid");
      const mediaSearch = document.getElementById("media-search");
      const mediaEmpty = document.getElementById("media-empty");
      const tmdbStatus = document.getElementById("tmdb-status");
      const sortSelect = document.getElementById("sort-select");

      let mediaCards = [];

      /* ============================================================
         CREATE CARD FROM TMDB
      ============================================================ */
      function createCardFromTMDB(movie) {
        const id = movie.id;
        const title = movie.title || movie.name || "Untitled";
        const posterPath = movie.poster_path || movie.backdrop_path;

        const a = document.createElement("a");
        a.className = "media-card tmdb-card";
        a.href = "#";
        a.dataset.title = title;
        a.dataset.tmdbId = String(id);
        a.dataset.popularity = movie.popularity || 0;
        a.dataset.released = movie.release_date || movie.first_air_date || "0";

        const thumb = document.createElement("div");
        thumb.className = "poster-thumb";

        const img = document.createElement("img");
        img.src = posterPath ? proxiedImg(posterPath) : "thumbs/placeholder-poster.png";
        img.alt = title;

        const overlay = document.createElement("div");
        overlay.className = "media-overlay";
        overlay.textContent = title;

        thumb.appendChild(img);
        thumb.appendChild(overlay);
        a.appendChild(thumb);

        a.addEventListener("click", (e) => {
          e.preventDefault();
          goToPlayer(title, "/scramjet/https://cinemaos.live/player/" + id);
        });

        return a;
      }

      /* ============================================================
         NAVIGATE TO PLAYER
      ============================================================ */
      function goToPlayer(title, src) {
        const url = "mediaplayer.html?src=" +
          encodeURIComponent(src) +
          "&title=" +
          encodeURIComponent(title);

        window.location.href = url;
      }

      /* ============================================================
         STATIC CARD CLICK WIRING
      ============================================================ */
      function wireStaticCards() {
        mediaCards = Array.from(document.querySelectorAll(".media-card"));

        mediaCards.forEach((card) => {
          card.addEventListener("click", (e) => {
            e.preventDefault();

            const title = card.dataset.title;
            const id = card.dataset.tmdbId;
            const direct = card.dataset.src;

            const src = direct || "/scramjet/https://cinemaos.live/player/" + id;

            goToPlayer(title, src);
          });
        });
      }

      /* ============================================================
         FILTER
      ============================================================ */
      function filterMedia() {
        const q = (mediaSearch.value || "").toLowerCase().trim();
        let visible = 0;

        mediaCards.forEach((card) => {
          const title = card.dataset.title.toLowerCase();
          const match = !q || title.includes(q);

          card.style.display = match ? "" : "none";
          if (match) visible++;
        });

        mediaEmpty.style.display = visible === 0 ? "block" : "none";
      }

      /* ============================================================
         SORTING
      ============================================================ */
      function sortMedia() {
        const mode = sortSelect.value;

        let sorted = [...mediaCards].filter((c) =>
          c.closest("body") !== null
        );

        sorted.sort((a, b) => {
          const ta = a.dataset.title.toLowerCase();
          const tb = b.dataset.title.toLowerCase();

          if (mode === "az") return ta.localeCompare(tb);
          if (mode === "za") return tb.localeCompare(ta);
          if (mode === "popularity")
            return (parseFloat(b.dataset.popularity) || 0) -
                   (parseFloat(a.dataset.popularity) || 0);
          if (mode === "released")
            return new Date(b.dataset.released) - new Date(a.dataset.released);

          return 0;
        });

        sorted.forEach((el) => mediaGrid.appendChild(el));
      }

      /* ============================================================
         LOAD TRENDING
      ============================================================ */
      async function loadTrending() {
        if (!TMDB_KEY) {
          tmdbStatus.textContent = "TMDB key missing.";
          return;
        }

        try {
          tmdbStatus.textContent = "Fetching…";

          const res = await fetch(
            "https://api.themoviedb.org/3/trending/movie/day?api_key=" + TMDB_KEY
          );
          const data = await res.json();

          const frag = document.createDocumentFragment();

          (data.results || []).slice(0, 30).forEach((movie) => {
            const card = createCardFromTMDB(movie);
            frag.appendChild(card);
          });

          mediaGrid.prepend(frag);
          mediaCards = Array.from(document.querySelectorAll(".media-card"));

          tmdbStatus.textContent = "Loaded popular movies.";
        } catch (err) {
          tmdbStatus.textContent = "TMDB failed: " + err.message;
        }
      }

      /* ============================================================
         INIT
      ============================================================ */
      document.addEventListener("DOMContentLoaded", async () => {
        wireStaticCards();
        await loadTrending();
        sortMedia();

        mediaSearch.addEventListener("input", () => {
          filterMedia();
        });

        sortSelect.addEventListener("change", () => {
          sortMedia();
          filterMedia();
        });

        filterMedia();
      });
    </script>
  </body>
</html>
